# MIAPure — Ballbot (UR5e) Manipulation Simulation

## Overview
This repository implements a complete simulation, planning and control framework for a **ballbot equipped with a UR5e manipulator** and a **Robotiq 2F-85 gripper**.  
The project explores *mobile manipulation on dynamically balancing platforms*, combining modeling, control, and motion planning techniques.

The work is inspired by the MIA-PURE research concept and aims to simulate the integration between a dynamically unstable **ballbot base** and a **6-DOF manipulator**, addressing challenges of stability, motion planning, and interaction.

The implemented framework integrates:
- Mathematical and Simscape-based dynamic models of the ballbot.
- Omnidirectional navigation and motion planning.
- Adaptive and model-based control strategies (LQR–PI, MRAC, hybrid compensation).
- Manipulation planning through ROS 2 and MoveIt Task Constructor.
- Batch testing and post-processing tools for performance analysis.

---

## Introduction & Goals
The goal of the project is to study and simulate **mobile manipulation** on a ballbot platform — a self-balancing robot whose dynamics resemble a 3D inverted pendulum.  
The main challenges addressed are:
- Stability control under actuation coupling.
- Robust motion and trajectory tracking during navigation.
- Coordinated manipulation with a mounted robotic arm.
- Integration between MATLAB/Simulink (for control) and ROS 2/MoveIt (for planning).

The repository includes everything needed to reproduce the simulations and analysis presented in the project report *“FSR_Project_Rocco_Panagrosso.pdf”*.

---

## Implemented Features

### 1. Dynamic Modeling
- Lagrangian derivation of the ballbot dynamics, decoupled into sagittal, frontal, and transverse planes.
- Torque mapping from three omni-wheels to equivalent planar torques.
- Open-loop validation of the derived equations using MATLAB simulations.
- Parameter identification consistent with the physical prototype specifications.

### 2. Control Architectures
Three control strategies are implemented and tested:

#### • Cascaded LQR–PI Control
A linear–quadratic regulator computes optimal torques from the full-state model, while an inner PI loop compensates for unmodeled dynamics and friction.  
This controller ensures precise velocity tracking and stable balancing even in the presence of model mismatches.

#### • Model Reference Adaptive Control (MRAC)
An adaptive control scheme updates gains `K(t)`, `Kr(t)`, and `Ke(t)` in real time, allowing the ballbot to adapt to uncertainties such as changing payloads.  
The MRAC controller improves robustness at the cost of higher transient torques.

#### • Hybrid Compensated LQR–PI
An enhanced version of the LQR–PI controller that introduces a feedforward compensation based on equilibrium torque (`τ_EQ`) and tilt (`θ_EQ`) estimation.  
This enables rejection of slow-varying external wrenches such as those generated by manipulator actions.

### 3. Motion Planning
- Implementation of **RRT\*** for path planning on a `binaryOccupancyMap` with obstacle inflation.
- Segment-wise trapezoidal or triangular velocity profiles for smooth motion.
- Lookahead feedback correction to improve tracking and reduce base tilt.
- Support for both 2D navigation and yaw control.

### 4. Manipulator Planning and Integration
- Integration of a **UR5e manipulator** imported from URDF into Simscape Multibody.
- Fixes and handling of **mimic joints** for gripper synchronization.
- **ROS 2 + MoveIt Task Constructor** pipeline for manipulation planning:
  - Symbolic HTN planner produces task sequences.
  - MoveIt MTC generates collision-free trajectories.
  - Joint trajectories are exported (rosbag) and post-processed in MATLAB for Simulink execution.
- Supports smooth trajectory resampling and filtering to remove temporal artifacts due to simulation rate mismatch.

### 5. Batch Testing and Result Analysis
- Automated randomized simulations (`runBatchTests.m`, `runBallbotSimulation.m`) to test robustness under varying parameters.
- Results are saved as `.mat` files and analyzed using the provided `analyze_results` tools.
- Generation of correlation tables, performance metrics (RMSE, MAE, tilt angles), and comparative plots between controllers.

---

## Repository Structure

Below is a detailed map of the repository’s folders and scripts, including the original Italian notes for context.

### `OL_generated_eq/`
> *Italian:* “Permette di eseguire una simulazione basata sulle equazioni matematiche su MATLAB, senza controllo, del ballbot (senza manipolatore).”  
Simulates the **open-loop mathematical model** of the ballbot (no control, no manipulator) to verify its inverted-pendulum behavior and validate the derived dynamics.

### `PID_LQR_PI/`
> *Italian:* “Implementa il controllo LQR–PI in cascata, per tunare i parametri e verificarne l’efficacia senza disturbi esterni.”  
Implements the **cascaded LQR–PI controller** for closed-loop control of the ballbot base.  
Used to tune gains and evaluate the controller’s stability in ideal (disturbance-free) conditions.

### `manipulator_sim/`
> *Italian:* “Permette il caricamento del modello Simscape (mesh, inertia, gripper…) del manipolatore integrato con le equazioni MATLAB.”  
Contains the **Simscape/Simulink model of the UR5e manipulator and Robotiq 2F-85 gripper**, imported via URDF.  
Integrates the manipulator with the ballbot base through Cartesian and spherical joints, ensuring consistent dynamics.

### `Planning_sim/`
> *Italian:* “Script principale. Lancia una simulazione completa di pianificazione, navigazione e manipolazione.”  
The **main orchestration script** for full simulation.  
It performs:
- Navigation path generation (RRT*).
- Velocity profile computation.
- Simulink model execution (`scheme_pos_control_yawcontrol`).
- Transition to manipulation once the goal is reached.  
Optionally, the user can switch to `scheme_fullbodycontrol` for full-body integrated experiments.

### `Planning_w_Adaptive/`
> *Italian:* “Avvia una simulazione solo per la base mobile con controllo adattivo.”  
Runs simulations using the **adaptive MRAC controller** for the mobile base only, based on the model reference technique.

### `runBatchTests.m` and `runBallbotSimulation.m`
> *Italian:* “File utilizzati per eseguire test randomici in diversi scenari.”  
Utilities to perform multiple randomized simulations under varying conditions (e.g., payload, initial tilt, friction).  
All results are automatically saved as `.mat` archives.

### `analyze_results/`
Contains analysis tools to process simulation data, visualize results, and compute correlation statistics.  
This folder is used to reproduce the performance tables and figures shown in the report.

### `ros2_moveit_integration/`
Includes ROS 2 nodes for MoveIt Task Constructor integration:
- HTN symbolic plan publishing.
- Task sequence execution.
- Rosbag trajectory export for MATLAB post-processing.

---

## How to Run Simulations

1. **Open-loop model validation**  
   Run scripts in `OL_generated_eq/` to simulate the ballbot without any controller and observe its unstable inverted-pendulum behavior.

2. **Controlled ballbot (no manipulator)**  
   Open and run the Simulink models in `PID_LQR_PI/` to test the cascaded LQR–PI control architecture.

3. **Full navigation and manipulation**  
   Run the script `Planning_sim.m` to execute the complete scenario:
   - Path planning and velocity profiling.
   - Simulink model `scheme_pos_control_yawcontrol` execution.
   - Trigger manipulation sequence at the target position.

4. **Adaptive control testing**  
   Run `Planning_w_Adaptive.m` to validate MRAC controller performance.

5. **Batch experiments and analysis**  
   Launch `runBatchTests.m` to automatically test multiple parameter configurations.  
   Once complete, open `analyze_results/` to visualize results and correlation metrics.

---

## Key Simulink Models

- **`scheme_pos_control_yawcontrol`** — main simulation model integrating navigation, yaw control, and task-switch logic for manipulation.  
- **`scheme_fullbodycontrol`** — experimental model for coupling manipulator and base dynamics in a unified controller (currently not fully functional).  
- **`scheme_w_Adaptive`** — used for MRAC-based base control simulations.

---

## Result Files and Visualization

All `.mat` files generated by batch simulations contain:
- Trajectories, state histories, and torque signals.
- Performance indicators (RMSE, MAE, mean/max tilt).
- Controller configuration metadata.

These can be loaded in MATLAB and analyzed through the provided functions in `analyze_results/`, which produce tables and plots comparing:
- Controller types (LQR–PI, MRAC, hybrid).
- Tilt response and tracking error.
- Correlations between gains and performance.

---

## Notes on Controllers and Algorithms

### RRT\* Planning
- Planner operates on a 2D occupancy map with obstacle inflation.
- Parameters: connection distance, maximum iterations, and smoothing factor.
- The planner produces a collision-free path used as reference for velocity profiling.

### Velocity Profiling
- Generates smooth trapezoidal or triangular speed profiles along the path.
- Incorporates lookahead feedback to improve trajectory tracking.
- Comparison of different lookahead distances is available in the analysis results.

### Cascade LQR–PI
- The outer LQR computes a model-based torque reference.
- The inner PI ensures tracking of sphere velocity and compensates modeling errors.
- Provides stable and accurate tracking with low steady-state error.

### MRAC (Model Reference Adaptive Control)
- Adjusts control gains in real-time using adaptive laws.
- Provides robustness to parametric uncertainty and external disturbances.
- Must be carefully tuned to avoid excessive torque transients.

### Manipulation Integration
- The manipulator’s dynamics are treated as an external wrench applied to the base.
- Vertical loads are compensated separately to avoid instability.
- Operational-space compensation was tested but revealed strong coupling effects — a true full-body controller would be required for optimal results.

---

## Known Issues and Limitations
- The **MRAC controller** may produce large transient torques; initial references should be smoothed.  
- The **full-body control scheme** is experimental and not yet stable.  
- Time synchronization between ROS and MATLAB simulations can introduce minor trajectory misalignments if rosbag data is not post-processed.  
- The Simscape manipulator model requires manual fixing of **mimic joints** for the gripper.

---

## Credits
Developed by **Roberto Rocco** as part of the Master’s project in Automation and Robotics Engineering at the University of Naples.

For further details, see the attached report:
**FSR_Project_Rocco_Panagrosso.pdf**

Contact: `roby.rocco01@gmail.com`

---

## License
This project is released for academic and research purposes only.  
Reproduction or modification is permitted with proper attribution.

